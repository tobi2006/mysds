{% extends "base.html" %}
{% load custom_filters %}

{% block title %}CCCU Law - {{current_module}}{% endblock %}

{% block content %}

{% url "mark" as action_url%}

<h2>
    Marks for {{ current_module.title }} ({{ current_module.year }})
</h2>

<table id ="sortable_table" class="table table-striped table-sortable">
    <thead>
        <tr>
            <th>
                Student
            </th>
            {% if current_module.assessment_1_title %}
                <th>
                    {{ current_module.assessment_1_title }} ({{ current_module.assessment_1_value }}%)
                </th>
            {% endif %}
            {% if current_module.assessment_2_title %}
                <th>
                    {{ current_module.assessment_2_title }} ({{ current_module.assessment_2_value }}%)
                </th>
            {% endif %}
            {% if current_module.assessment_3_title %}
                <th>
                    {{ current_module.assessment_3_title }} ({{ current_module.assessment_3_value }}%)
                </th>
            {% endif %}
            {% if current_module.assessment_4_title %}
                <th>
                    {{ current_module.assessment_4_title }} ({{ current_module.assessment_4_value }}%)
                </th>
            {% endif %}
            {% if current_module.assessment_5_title %}
                <th>
                    {{ current_module.assessment_5_title }} ({{ current_module.assessment_5_value }}%)
                </th>
            {% endif %}
            {% if current_module.assessment_6_title %}
                <th>
                    {{ current_module.assessment_6_title }} ({{ current_module.assessment_6_value }}%)
                </th>
            {% endif %}
            {% if current_module.exam_value %}
                <th>
                    Exam ({{ current_module.exam_value }}%)
                </th>
            {% endif %}
            <th>
                Module Mark
            </th>
        </tr>
    </thead>
    <tbody>
        <form action="{{ action_url }}" id="markForm" method="post"> 
        {% csrf_token %}
        

    {% for student, performance in performances.items|sort %}
        <tr>
            <td>
                <label>{{ student }}</label>
            </td>
            {% if current_module.assessment_1_title %}
                <td id="{{ performance.student.student_id }}_1" >
                    {% if to_mark == 1 %}
                        {% if performance.assessment_1 %}
                        <input type="text" class="input-mini" minlenght="5" name="{{ performance.student.student_id }}" value="{{ performance.assessment_1 }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% else %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% endif %}
                    {% else %}
                        {{ performance.assessment_1 }}
                    {% endif %}
                </td>
            {% endif %}
            {% if current_module.assessment_2_title %}
                <td id="{{ performance.student.student_id }}_2">
                    {% if to_mark == 2 %}
                        {% if performance.assessment_2 %}
                        <input type="text" class="input-mini" name="{{ performance.student.student_id }}" value="{{ performance.assessment_2 }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% else %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% endif %}
                    {% else %}
                        {{ performance.assessment_2 }}
                    {% endif %}
                </td>
            {% endif %}
            {% if current_module.assessment_3_title %}
                <td id="{{ performance.student.student_id }}_3">
                    {% if to_mark == 3 %}
                        {% if performance.assessment_3 %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" value="{{ performance.assessment_3 }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% else %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% endif %}
                    {% else %}
                        {{ performance.assessment_3 }}
                    {% endif %}
                </td>
            {% endif %}
            {% if current_module.assessment_4_title %}
                <td id="{{ performance.student.student_id }}_4">
                    {% if to_mark == 4 %}
                        {% if performance.assessment_4 %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" value="{{ performance.assessment_4 }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% else %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% endif %}
                    {% else %}
                        {{ performance.assessment_4 }}
                    {% endif %}
                </td>
            {% endif %}
            {% if current_module.assessment_5_title %}
                <td id="{{ performance.student.student_id }}_5">
                    {% if to_mark == 5 %}
                        {% if performance.assessment_5 %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" value="{{ performance.assessment_5 }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% else %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% endif %}
                    {% else %}
                        {{ performance.assessment_5 }}
                    {% endif %}
                </td>
            {% endif %}
            {% if current_module.assessment_6_title %}
                <td id="{{ performance.student.student_id }}_6">
                    {% if to_mark == 6 %}
                        {% if performance.assessment_6 %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" value="{{ performance.assessment_6 }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% else %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% endif %}
                    {% else %}
                        {{ performance.assessment_6 }}
                    {% endif %}
                </td>
            {% endif %}
            {% if current_module.exam_value %}
                <td id="{{ performance.student.student_id }}_e">
                    {% if to_mark == 9 %}
                        {% if performance.exam %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" value="{{ performance.exam }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% else %}
                            <input type="text" class="input-mini" name="{{ performance.student.student_id }}" onchange="process(this, '{{ performance.student.student_id }}')">
                        {% endif %}
                    {% else %}
                        {{ performance.exam }}
                    {% endif %}
                </td>
            {% endif %}
            <td id="{{ performance.student.student_id }}_average">
                {{ performance.average }}
            </td>
            <td id="{{ performance.student.student_id }}_error">
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<input type="submit" value="Save Marks" class="btn btn-primary" align=right>
</form>

{% comment %}

Problem for Average: (65*40 + 56*60) / 100 = 59.6 but gets saved as 59!

The below JS function validates the entry (number between 0 and 100) and calculates the average on the
fly, so the marker sees what effect the mark will have. It might be a good idea to add more conditionals
about the average to give warnings if the mark ends with 9 or is a failing grade.

{% endcomment %}

<script>
function process(elem, student_id){
    var errortag = student_id + "_error"
	var numericExpression = /^[0-9]+$/;
	if(elem.value.match(numericExpression) && Number(elem.value) >= 0 && Number(elem.value) <= 100){
                document.getElementById(errortag).innerHTML="";
                var sum = 0;
                {% if current_module.assessment_1_title %}
                    {% if to_mark == 1 %}
                        entry = Number(elem.value);
                    {% else %}
                        marktag = student_id + "_1";
                        raw_entry = document.getElementById(marktag).innerHTML;
                        if (raw_entry.indexOf("None") != -1)
                            {
                                entry = 0;
                            }
                        else
                            {
                                entry = Number(raw_entry);
                            };
                    {% endif %}
                    value = entry * {{ current_module.assessment_1_value }};
                    sum = sum + value;
                {% endif %}
                {% if current_module.assessment_2_title %}
                    {% if to_mark == 2 %}
                        entry = Number(elem.value);
                    {% else %}
                        marktag = student_id + "_2";
                        raw_entry = document.getElementById(marktag).innerHTML;
                        if (raw_entry.indexOf("None") != -1)
                            {
                                entry = 0;
                            }
                        else
                            {
                                entry = Number(raw_entry);
                            };
                    {% endif %}
                    value = entry * {{ current_module.assessment_2_value }};
                    sum = sum + value;
                {% endif %}
                {% if current_module.assessment_3_title %}
                    {% if to_mark == 3 %}
                        entry = Number(elem.value);
                    {% else %}
                        marktag = student_id + "_3";
                        raw_entry = document.getElementById(marktag).innerHTML;
                        if (raw_entry.indexOf("None") != -1)
                            {
                                entry = 0;
                            }
                        else
                            {
                                entry = Number(raw_entry);
                            };
                    {% endif %}
                    value = entry * {{ current_module.assessment_3_value }};
                    sum = sum + value;
                {% endif %}
                {% if current_module.assessment_4_title %}
                    {% if to_mark == 4 %}
                        entry = Number(elem.value);
                    {% else %}
                        marktag = student_id + "_4";
                        raw_entry = document.getElementById(marktag).innerHTML;
                        if (raw_entry.indexOf("None") != -1)
                            {
                                entry = 0;
                            }
                        else
                            {
                                entry = Number(raw_entry);
                            };
                    {% endif %}
                    value = entry * {{ current_module.assessment_4_value }};
                    sum = sum + value;
                {% endif %}
                {% if current_module.assessment_5_title %}
                    {% if to_mark == 5 %}
                        entry = Number(elem.value);
                    {% else %}
                        marktag = student_id + "_5";
                        raw_entry = document.getElementById(marktag).innerHTML;
                        if (raw_entry.indexOf("None") != -1)
                            {
                                entry = 0;
                            }
                        else
                            {
                                entry = Number(raw_entry);
                            };
                    {% endif %}
                    value = entry * {{ current_module.assessment_5_value }};
                    sum = sum + value;
                {% endif %}
                {% if current_module.assessment_6_title %}
                    {% if to_mark == 6 %}
                        entry = Number(elem.value);
                    {% else %}
                        marktag = student_id + "_6";
                        raw_entry = document.getElementById(marktag).innerHTML;
                        if (raw_entry.indexOf("None") != -1)
                            {
                                entry = 0;
                            }
                        else
                            {
                                entry = Number(raw_entry);
                            };
                    {% endif %}
                    value = entry * {{ current_module.assessment_6_value }};
                    sum = sum + value;
                {% endif %}
                {% if current_module.exam_value %}
                    {% if to_mark == 9 %}
                        entry = Number(elem.value);
                    {% else %}
                        marktag = student_id + "_e";
                        raw_entry = document.getElementById(marktag).innerHTML;
                        if (raw_entry.indexOf("None") != -1)
                            {
                                entry = 0;
                            }
                        else
                            {
                                entry = Number(raw_entry);
                            };
                    {% endif %}
                    value = entry * {{ current_module.exam_value }};
                    sum = sum + value;
                {% endif %}
                average = sum / 100;
                rounded_average = Math.round(average)
                averagetag = student_id + '_average'
                document.getElementById(averagetag).innerHTML=rounded_average;
	}else{
        document.getElementById(errortag).innerHTML="Enter a mark between 0 and 100";
		elem.focus();
	}
}
</script>


{% endblock %}
